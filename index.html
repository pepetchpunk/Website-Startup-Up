<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Startup Up Real Estate</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX compilation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Map for ES Modules (React, Firebase, Lucide) -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "firebase/app": "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js",
            "firebase/storage": "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
        }
    }
    </script>
</head>
<body>
    <!-- Root element for React -->
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { createRoot } from 'react-dom/client';
        import React, { useState, useEffect } from 'react';
        import { initializeApp } from 'firebase/app';
        import { 
          getAuth, 
          signInAnonymously, 
          signInWithCustomToken, 
          onAuthStateChanged,
          GoogleAuthProvider,
          signInWithPopup
        } from 'firebase/auth';
        import { 
          getStorage, 
          ref, 
          uploadBytes, 
          getDownloadURL 
        } from 'firebase/storage';
        import { 
          getFirestore, 
          collection, 
          addDoc, 
          deleteDoc, 
          doc, 
          updateDoc, 
          onSnapshot, 
          query, 
          serverTimestamp, 
          setDoc, 
          orderBy
        } from 'firebase/firestore';
        import { 
          Home, MapPin, Bed, Bath, Car, Maximize,
          Phone, MessageCircle, Menu, X, Plus, Trash2, 
          ShieldCheck, CheckCircle, Calculator, Users, 
          FileText, Settings, Edit, Save, Image as ImageIcon, 
          Layout, ChevronLeft, ChevronRight, Upload, Briefcase, 
          XCircle, Tag, Youtube, Loader, Facebook, Instagram, 
          Video, Check, Calendar, FolderPlus, Map
        } from 'lucide-react';

        // --- Firebase Configuration ---
        // แก้ไขให้รองรับทั้งระบบพรีวิวและ Vercel (Create React App / Next.js)
        const getFirebaseConfig = () => {
          if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            return JSON.parse(__firebase_config);
          }
          
          const env = typeof process !== 'undefined' && process.env ? process.env : {};
          
          return {
            apiKey: env.REACT_APP_FIREBASE_API_KEY || "",
            authDomain: env.REACT_APP_FIREBASE_AUTH_DOMAIN || "",
            projectId: env.REACT_APP_FIREBASE_PROJECT_ID || "",
            storageBucket: env.REACT_APP_FIREBASE_STORAGE_BUCKET || "",
            messagingSenderId: env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID || "",
            appId: env.REACT_APP_FIREBASE_APP_ID || ""
          };
        };

        const firebaseConfig = getFirebaseConfig();
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        // Use the system-provided ID or fallback for Vercel deployment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- Constants ---
        const HOST_EMAIL = 'pepetchpunk@gmail.com';

        const DEFAULT_COMPANY_INFO = {
          name: 'STARTUP UP',
          address: '39/43 หมู่ 5 ต.คลองสาม อ.คลองหลวง จ.ปทุมธานี 12120',
          phone: '0624782426',
          email: 'startup.up.real.estate@gmail.com',
          line: 'https://line.me/R/ti/p/@SURE141',
          facebook: 'https://www.facebook.com/startupuprealestate/',
          description: 'ผู้นำด้านการซื้อ-ขาย บ้านมือสองรีโนเวทคุณภาพ ย่านรังสิต-ปทุมธานี',
          logoUrl: 'https://lh3.googleusercontent.com/d/1EEAbI2a89rG4ii0Um0cfWdXLtcb6I_RU',
          portfolio_years: []
        };

        const CATEGORIES = [
          'ทาวน์เฮาส์',
          'ทาวน์เฮาส์ชั้นเดียว',
          'ทาวน์เฮาส์หลังริม',
          'บ้านแฝด',
          'บ้านเดี่ยว'
        ];

        const BADGES = [
          { value: '', label: '- ปกติ (ขายทั่วไป) -' },
          { value: 'Promotion', label: 'Promotion (โปรโมชั่น)' },
          { value: 'New', label: 'New (มาใหม่)' },
          { value: 'Sold Out', label: 'Sold Out (ขายแล้ว/ย้ายไปผลงาน)' }
        ];

        const DIRECTIONS = [
          'เหนือ', 'ใต้', 'ตะวันออก', 'ตะวันตก', 
          'ตะวันออกเฉียงเหนือ', 'ตะวันออกเฉียงใต้', 
          'ตะวันตกเฉียงเหนือ', 'ตะวันตกเฉียงใต้'
        ];

        const COMMON_FACILITIES = [
          "รปภ. 24 ชม.", "สระว่ายน้ำ", "ฟิตเนส", "สวนสาธารณะ", 
          "กล้อง CCTV", "เข้า-ออก ระบบคีย์การ์ด", "คลับเฮาส์", 
          "สนามเด็กเล่น", "ใกล้ทางด่วน", "ใกล้รถไฟฟ้า", 
          "ใกล้ห้างสรรพสินค้า", "ใกล้โรงเรียน", "ใกล้โรงพยาบาล",
          "ที่จอดรถส่วนตัว", "ถนนกว้าง", "รีโนเวทใหม่", "พร้อมอยู่"
        ];

        const LOCATIONS_DATA = [
          { 
            area: 'ลำลูกกา', 
            sub_areas: ['ลำลูกกา คลอง 2', 'ลำลูกกา คลอง 3', 'ลำลูกกา คลอง 4', 'ลำลูกกา คลอง 7'],
            img: 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'
          },
          { 
            area: 'คลองหลวง', 
            sub_areas: ['คลองหลวง คลอง 1', 'คลองหลวง คลอง 2', 'คลองหลวง คลอง 3', 'คลองหลวง คลอง 4'],
            img: 'https://images.unsplash.com/photo-1592595896551-12b371d546d5?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'
          },
          { 
            area: 'ธัญบุรี', 
            sub_areas: ['ธัญญะ คลอง 2', 'ธัญญะ คลอง 3', 'ธัญบุรี คลอง 4', 'ธัญบุรี คลอง 8'],
            img: 'https://images.unsplash.com/photo-1512917774080-9991f1c4c750?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'
          },
          { 
            area: 'เมืองปทุมธานี / อยุธยา', 
            sub_areas: ['บ้านใหม่', 'บางพูน', 'บางกะดี', 'อ.วังน้อย อยุธยา', 'พยอม'],
            img: 'https://images.unsplash.com/photo-1600585154340-be6161a56a0c?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'
          },
          { 
            area: 'กรุงเทพมหานคร', 
            sub_areas: ['ดอนเมือง', 'บางเขน', 'พหลโยธิน 48', 'พหลโยธิน 52', 'สายไหม'],
            img: 'https://images.unsplash.com/photo-1582268611958-ebfd161ef9cf?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'
          },
          { 
            area: 'นนทบุรี', 
            sub_areas: ['บางบัวทอง', 'ปากเกร็ด', 'ติวานนท์'],
            img: 'https://images.unsplash.com/photo-1580587771525-78b9dba3b91d?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80'
          }
        ];

        // Updated DB structure: Key -> Array of Objects to support Dropdown
        const THAI_ADDRESS_DB = {
          '12120': [
            { subdistrict: 'คลองสาม', district: 'คลองหลวง', province: 'ปทุมธานี' },
            { subdistrict: 'คลองสี่', district: 'คลองหลวง', province: 'ปทุมธานี' },
            { subdistrict: 'คลองหนึ่ง', district: 'คลองหลวง', province: 'ปทุมธานี' },
            { subdistrict: 'คลองสอง', district: 'คลองหลวง', province: 'ปทุมธานี' }
          ],
          '12110': [
            { subdistrict: 'บางคูวัด', district: 'เมืองปทุมธานี', province: 'ปทุมธานี' },
            { subdistrict: 'บางขะแยง', district: 'เมืองปทุมธานี', province: 'ปทุมธานี' }
          ],
          '12130': [
            { subdistrict: 'ประชาธิปัตย์', district: 'ธัญบุรี', province: 'ปทุมธานี' },
            { subdistrict: 'บึงยี่โถ', district: 'ธัญบุรี', province: 'ปทุมธานี' },
            { subdistrict: 'รังสิต', district: 'ธัญบุรี', province: 'ปทุมธานี' }
          ], 
          '12150': [
            { subdistrict: 'คูคต', district: 'ลำลูกกา', province: 'ปทุมธานี' },
            { subdistrict: 'ลาดสวาย', district: 'ลำลูกกา', province: 'ปทุมธานี' },
            { subdistrict: 'บึงคำพร้อย', district: 'ลำลูกกา', province: 'ปทุมธานี' },
            { subdistrict: 'ลำลูกกา', district: 'ลำลูกกา', province: 'ปทุมธานี' }
          ],
          '12140': [{ subdistrict: 'ระแหง', district: 'ลาดหลุมแก้ว', province: 'ปทุมธานี' }],
          '12160': [{ subdistrict: 'กระแชง', district: 'สามโคก', province: 'ปทุมธานี' }],
          '12170': [{ subdistrict: 'บึงบา', district: 'หนองเสือ', province: 'ปทุมธานี' }],
          '12000': [{ subdistrict: 'บางปรอก', district: 'เมืองปทุมธานี', province: 'ปทุมธานี' }],
          '10210': [{ subdistrict: 'ทุ่งสองห้อง', district: 'หลักสี่', province: 'กรุงเทพมหานคร' }],
          '10220': [
            { subdistrict: 'อนุสาวรีย์', district: 'บางเขน', province: 'กรุงเทพมหานคร' },
            { subdistrict: 'ท่าแร้ง', district: 'บางเขน', province: 'กรุงเทพมหานคร' }
          ],
          '10230': [{ subdistrict: 'จรเข้บัว', district: 'ลาดพร้าว', province: 'กรุงเทพมหานคร' }],
          '10510': [
            { subdistrict: 'คลองถนน', district: 'สายไหม', province: 'กรุงเทพมหานคร' },
            { subdistrict: 'สายไหม', district: 'สายไหม', province: 'กรุงเทพมหานคร' },
            { subdistrict: 'ออเงิน', district: 'สายไหม', province: 'กรุงเทพมหานคร' }
          ],
          '10240': [{ subdistrict: 'หัวหมาก', district: 'บางกะปิ', province: 'กรุงเทพมหานคร' }],
          '10900': [{ subdistrict: 'จอมพล', district: 'จตุจักร', province: 'กรุงเทพมหานคร' }],
          '11120': [{ subdistrict: 'ปากเกร็ด', district: 'ปากเกร็ด', province: 'นนทบุรี' }],
          '11110': [{ subdistrict: 'บางรักน้อย', district: 'เมืองนนทบุรี', province: 'นนทบุรี' }],
        };

        // --- Helper Functions ---
        const resizeImage = (file) => {
          return new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = (event) => {
              const img = new Image();
              img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_WIDTH = 1000;
                const MAX_HEIGHT = 1000;
                let width = img.width;
                let height = img.height;

                if (width > height) {
                  if (width > MAX_WIDTH) {
                    height *= MAX_WIDTH / width;
                    width = MAX_WIDTH;
                  }
                } else {
                  if (height > MAX_HEIGHT) {
                    width *= MAX_HEIGHT / height;
                    height = MAX_HEIGHT;
                  }
                }
                canvas.width = width;
                canvas.height = height;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, width, height);
                resolve(canvas.toDataURL('image/jpeg', 0.8)); 
              };
              img.src = event.target.result;
            };
            reader.readAsDataURL(file);
          });
        };

        const uploadBase64ToStorage = async (base64String) => {
          if (!base64String || base64String.startsWith('http')) return base64String;

          // Convert Base64 to Blob
          const arr = base64String.split(',');
          const mime = arr[0].match(/:(.*?);/)[1];
          const bstr = atob(arr[1]);
          let n = bstr.length;
          const u8arr = new Uint8Array(n);
          while(n--){ u8arr[n] = bstr.charCodeAt(n); }
          const blob = new Blob([u8arr], {type:mime});

          // Upload to Firebase Storage
          const fileName = `images/${Date.now()}_${Math.random().toString(36).substr(2, 9)}.jpg`;
          const storageRef = ref(storage, fileName);
          await uploadBytes(storageRef, blob);
            
          return await getDownloadURL(storageRef);
        };

        const getYoutubeId = (url) => {
          if (!url) return null;
          const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=|shorts\/)([^#&?]*).*/;
          const match = url.match(regExp);
          return (match && match[2].length === 11) ? match[2] : null;
        };

        // --- Main Application Component ---
        export default function App() {
          const [user, setUser] = useState(null);
          const [userRole, setUserRole] = useState(null); 
          const [userEmail, setUserEmail] = useState('');

          const [properties, setProperties] = useState([]);
          const [companyInfo, setCompanyInfo] = useState(DEFAULT_COMPANY_INFO);
          const [authorizedUsers, setAuthorizedUsers] = useState([]);
          const [loading, setLoading] = useState(true);
            
          // UI States
          const [isMenuOpen, setIsMenuOpen] = useState(false);
          const [activeTab, setActiveTab] = useState('home'); 
          const [searchParams, setSearchParams] = useState({ type: 'all', value: '' }); 
            
          const [selectedProperty, setSelectedProperty] = useState(null);
          const [showLoginModal, setShowLoginModal] = useState(false);
          const [showAdminPanel, setShowAdminPanel] = useState(false);

          // --- Auth Persistence & Data Loading ---
          useEffect(() => {
            const storedEmail = localStorage.getItem('adminEmail');
            const storedRole = localStorage.getItem('adminRole');
              
            if (storedEmail && storedRole) {
              setUserEmail(storedEmail);
              setUserRole(storedRole);
            }

            const initAuth = async () => {
              try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                  await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                  await signInAnonymously(auth);
                }
              } catch (error) {
                console.error("Auth init handled safely:", error);
              }
            };
            initAuth();
              
            return onAuthStateChanged(auth, setUser);
          }, []);

          useEffect(() => {
            if (!user) return;

            // Load Properties
            const qProps = query(collection(db, 'artifacts', appId, 'public', 'data', 'properties'));
            const unsubProps = onSnapshot(qProps, (snapshot) => {
              const props = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              props.sort((a, b) => {
                 if (a.badge === 'Sold Out' && b.badge !== 'Sold Out') return 1;
                 if (a.badge !== 'Sold Out' && b.badge === 'Sold Out') return -1;
                 return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
              });
              setProperties(props);
              setLoading(false);
            });

            // Load Company Info
            const unsubCompany = onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'company_info', 'main'), (doc) => {
              if (doc.exists()) {
                setCompanyInfo({ ...DEFAULT_COMPANY_INFO, ...doc.data() });
              } else {
                setDoc(doc.ref, DEFAULT_COMPANY_INFO);
              }
            });

            // Load Authorized Users
            const qUsers = query(collection(db, 'artifacts', appId, 'public', 'data', 'users'));
            const unsubUsers = onSnapshot(qUsers, (snapshot) => {
              const users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setAuthorizedUsers(users);
              
              const hostExists = users.some(u => u.email === HOST_EMAIL);
              if (!hostExists && users.length === 0) {
                 setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', 'host_init'), {
                   email: HOST_EMAIL, role: 'host', name: 'Main Host', createdAt: serverTimestamp()
                 });
              }
            });

            return () => { unsubProps(); unsubCompany(); unsubUsers(); };
          }, [user]);

          // --- Handlers ---
          const handleLogin = (emailInput) => {
            const email = emailInput.toLowerCase().trim();
            const foundUser = authorizedUsers.find(u => u.email === email);
              
            if (email === HOST_EMAIL.toLowerCase()) {
              setUserRole('host'); setUserEmail(email);
              localStorage.setItem('adminEmail', email); 
              localStorage.setItem('adminRole', 'host'); 
              setShowLoginModal(false); setShowAdminPanel(true);
            } else if (foundUser) {
              setUserRole(foundUser.role); setUserEmail(email);
              localStorage.setItem('adminEmail', email); 
              localStorage.setItem('adminRole', foundUser.role); 
              setShowLoginModal(false); setShowAdminPanel(true);
            } else {
              alert('อีเมลนี้ไม่มีสิทธิ์เข้าใช้งานระบบ');
            }
          };

          const handleLogout = () => {
            setUserRole(null); setUserEmail('');
            localStorage.removeItem('adminEmail');
            localStorage.removeItem('adminRole');
            setShowAdminPanel(false); setActiveTab('home');
          };

          const handleGoogleLogin = async () => {
            const provider = new GoogleAuthProvider();
            try {
              const result = await signInWithPopup(auth, provider);
              const email = result.user.email.toLowerCase();
              
              // ตรวจสอบสิทธิ์จากฐานข้อมูล users ที่เรามีอยู่เดิม
              const foundUser = authorizedUsers.find(u => u.email === email);
              const isHost = email === HOST_EMAIL.toLowerCase();

              if (isHost || foundUser) {
                const role = isHost ? 'host' : foundUser.role;
                setUserRole(role);
                setUserEmail(email);
                localStorage.setItem('adminEmail', email);
                localStorage.setItem('adminRole', role);
                setShowLoginModal(false);
                setShowAdminPanel(true);
              } else {
                // ถ้าไม่มีสิทธิ์ ให้สั่ง Sign out ออกทันที
                await auth.signOut();
                alert('บัญชี Gmail นี้ไม่มีสิทธิ์เข้าใช้งานระบบ');
              }
            } catch (error) {
              console.error("Login Error:", error);
              alert('เกิดข้อผิดพลาดในการล็อคอิน');
            }
          };

          const handleLocationSelect = (type, value) => {
            setSearchParams({ type, value });
            setActiveTab('search_result');
            setSelectedProperty(null);
          };

          return (
            <div className="text-stone-800 bg-stone-50 min-h-screen flex flex-col font-sans">
              <style>
                {`
                  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;700&display=swap');
                  body { font-family: 'Noto Sans Thai', sans-serif; }
                  .input-modern {
                    width: 100%;
                    padding: 0.75rem;
                    border: 1px solid #e7e5e4;
                    border-radius: 0.5rem;
                    background-color: white;
                    transition: all 0.2s;
                    outline: none;
                  }
                  .input-modern:focus {
                    border-color: #116900;
                    box-shadow: 0 0 0 2px rgba(17, 105, 0, 0.1);
                    background-color: #fafff9;
                  }
                  .label {
                    display: block;
                    margin-bottom: 0.5rem;
                    font-weight: 500;
                    color: #44403c;
                    font-size: 0.9rem;
                  }
                  .btn-primary {
                     background-color: #116900;
                     color: white;
                     font-weight: bold;
                     padding: 0.75rem 1.5rem;
                     border-radius: 0.5rem;
                     transition: all 0.2s;
                     display: flex;
                     align-items: center;
                     justify-content: center;
                     gap: 0.5rem;
                  }
                  .btn-primary:hover {
                     background-color: #0d5200;
                     box-shadow: 0 4px 6px -1px rgba(17, 105, 0, 0.3);
                  }
                `}
              </style>
                
              {/* Navigation */}
              <nav className="bg-white shadow-md sticky top-0 z-50 border-b-4 border-[#116900]">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 w-full">
                  <div className="flex justify-between h-20">
                    <div className="flex items-center cursor-pointer" onClick={() => {setActiveTab('home'); setSelectedProperty(null);}}>
                      <div className="flex-shrink-0 flex items-center gap-2">
                        <div className="w-10 h-10 bg-white rounded-lg flex items-center justify-center text-[#116900] font-bold text-xl shadow-lg shadow-stone-200 overflow-hidden border border-stone-100">
                          {companyInfo?.logoUrl ? <img src={companyInfo.logoUrl} className="w-full h-full object-cover" alt="Logo"/> : 'S'}
                        </div>
                        <div>
                          <h1 className="text-xl font-bold text-[#116900] tracking-tight">{companyInfo?.name || 'STARTUP UP'}</h1>
                          <p className="text-xs text-stone-500 uppercase tracking-wider">Real Estate Next Gen</p>
                        </div>
                      </div>
                    </div>

                    <div className="hidden lg:flex items-center space-x-6">
                      <NavButton active={activeTab === 'home'} onClick={() => {setActiveTab('home'); setSelectedProperty(null);}}>หน้าหลัก</NavButton>
                      <NavButton active={activeTab === 'promo'} onClick={() => {setActiveTab('promo'); setSelectedProperty(null);}}>บ้านจัดโปรโมชั่น</NavButton>
                      <NavButton active={activeTab === 'location'} onClick={() => {setActiveTab('location'); setSelectedProperty(null);}}>ทำเล</NavButton>
                      <NavButton active={activeTab === 'calculator'} onClick={() => {setActiveTab('calculator'); setSelectedProperty(null);}}>คำนวณสินเชื่อ</NavButton>
                      <NavButton active={activeTab === 'portfolio'} onClick={() => {setActiveTab('portfolio'); setSelectedProperty(null);}}>ผลงานของบริษัท</NavButton>
                      
                      {userRole ? (
                         <button onClick={() => setShowAdminPanel(true)} className="flex items-center gap-2 px-4 py-2 bg-stone-800 text-white rounded-lg hover:bg-stone-900 transition shadow-md">
                          <Settings size={16} /> ระบบหลังบ้าน
                        </button>
                      ) : (
                        <button onClick={() => setShowLoginModal(true)} className="flex items-center gap-2 px-4 py-2 bg-[#116900]/10 text-[#116900] rounded-lg hover:bg-[#116900]/20 transition text-sm font-medium">
                          <ShieldCheck size={16} /> ผู้ดูแลระบบ
                        </button>
                      )}
                    </div>

                    <div className="lg:hidden flex items-center">
                      <button onClick={() => setIsMenuOpen(!isMenuOpen)} className="text-stone-600 hover:text-[#116900]">
                        {isMenuOpen ? <X size={28} /> : <Menu size={28} />}
                      </button>
                    </div>
                  </div>
                </div>

                {isMenuOpen && (
                  <div className="lg:hidden bg-white border-t border-stone-100 py-4 animate-in slide-in-from-top-5">
                    <div className="px-4 space-y-2">
                      <MobileNavBtn onClick={() => {setActiveTab('home'); setSelectedProperty(null); setIsMenuOpen(false)}}>หน้าหลัก</MobileNavBtn>
                      <MobileNavBtn onClick={() => {setActiveTab('promo'); setSelectedProperty(null); setIsMenuOpen(false)}}>บ้านจัดโปรโมชั่น</MobileNavBtn>
                      <MobileNavBtn onClick={() => {setActiveTab('location'); setSelectedProperty(null); setIsMenuOpen(false)}}>ทำเล</MobileNavBtn>
                      <MobileNavBtn onClick={() => {setActiveTab('calculator'); setSelectedProperty(null); setIsMenuOpen(false)}}>คำนวณสินเชื่อ</MobileNavBtn>
                      <MobileNavBtn onClick={() => {setActiveTab('portfolio'); setSelectedProperty(null); setIsMenuOpen(false)}}>ผลงานของบริษัท</MobileNavBtn>
                      <div className="h-px bg-stone-200 my-2"></div>
                      {userRole ? (
                        <button onClick={() => {setShowAdminPanel(true); setIsMenuOpen(false)}} className="w-full text-left px-3 py-3 text-stone-800 font-bold bg-stone-100 rounded-lg">ระบบหลังบ้าน</button>
                      ) : (
                        <button onClick={() => {setShowLoginModal(true); setIsMenuOpen(false)}} className="w-full text-left px-3 py-3 text-[#116900] font-bold">เข้าสู่ระบบ Admin</button>
                      )}
                    </div>
                  </div>
                )}
              </nav>

              {/* Main Content Area */}
              <div className="flex-grow">
                {selectedProperty ? (
                  <SalePage property={selectedProperty} companyInfo={companyInfo} onBack={() => setSelectedProperty(null)} />
                ) : (
                  <>
                    {activeTab === 'home' && <HomeSection properties={properties} loading={loading} onSelectProp={setSelectedProperty} setActiveTab={setActiveTab} />}
                    {activeTab === 'promo' && <PropertiesList properties={properties} searchParams={{ type: 'promo' }} onSelectProp={setSelectedProperty} />}
                    {activeTab === 'search_result' && <PropertiesList properties={properties} searchParams={searchParams} onSelectProp={setSelectedProperty} />}
                    {activeTab === 'location' && <LocationSection onSelectLocation={handleLocationSelect} />}
                    {activeTab === 'calculator' && <CalculatorSection />}
                    {activeTab === 'portfolio' && <PortfolioSection companyInfo={companyInfo} properties={properties} />}
                  </>
                )}
              </div>

              {/* Footer */}
              <footer className="bg-stone-900 text-stone-400 py-12 border-t-4 border-[#116900]">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                    <div>
                      <div className="flex items-center gap-2 mb-4 text-white">
                        <div className="w-8 h-8 bg-white rounded flex items-center justify-center font-bold overflow-hidden text-[#116900]">
                           {companyInfo?.logoUrl ? <img src={companyInfo.logoUrl} className="w-full h-full object-cover" alt="Logo"/> : 'S'}
                        </div>
                        <span className="text-lg font-bold">{companyInfo?.name || 'STARTUP UP'}</span>
                      </div>
                      <p className="text-sm leading-relaxed">{companyInfo?.description || 'ผู้นำด้านการซื้อ-ขาย บ้านมือสองรีโนเวทคุณภาพ ย่านรังสิต-ปทุมธานี'}</p>
                    </div>
                    <div>
                      <h4 className="text-white font-bold mb-4">ติดต่อเรา</h4>
                      <p className="mb-2">{companyInfo?.address || '39/43 หมู่ 5 ต.คลองสาม อ.คลองหลวง จ.ปทุมธานี 12120'}</p>
                      <p className="mb-2 text-white font-bold text-lg"><a href={`tel:${companyInfo?.phone || '0624782426'}`}>โทร: {companyInfo?.phone || '062-478-2426'}</a></p>
                      <p>Email: {companyInfo?.email || 'startup.up.real.estate@gmail.com'}</p>
                    </div>
                    <div>
                       <h4 className="text-white font-bold mb-4">ติดตามเรา</h4>
                       <div className="flex gap-4">
                         <a href={companyInfo?.facebook || 'https://www.facebook.com/startupuprealestate/'} target="_blank" rel="noreferrer" className="w-10 h-10 bg-[#1877F2] rounded-full flex items-center justify-center hover:opacity-80 transition text-white"><Facebook size={20}/></a>
                         <a href={companyInfo?.line || '#'} target="_blank" rel="noreferrer" className="w-10 h-10 bg-[#06C755] rounded-full flex items-center justify-center hover:opacity-80 transition text-white"><MessageCircle size={20}/></a>
                         <a href="https://www.instagram.com/startupuprealestate/" target="_blank" rel="noreferrer" className="w-10 h-10 bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 rounded-full flex items-center justify-center hover:opacity-80 transition text-white"><Instagram size={20}/></a>
                         <a href="https://www.tiktok.com/@startupupofficial?is_from_webapp=1&sender_device=pc" target="_blank" rel="noreferrer" className="w-10 h-10 bg-black border border-stone-700 rounded-full flex items-center justify-center hover:border-white transition text-white"><Video size={20}/></a>
                       </div>
                    </div>
                  </div>
                  <div className="border-t border-stone-800 pt-8 text-center text-sm">
                    © {new Date().getFullYear()} {companyInfo?.name || 'Startup Up Real Estate'}. All Rights Reserved.
                  </div>
                </div>
              </footer>

              {/* Modals */}
              {showLoginModal && <LoginModal onClose={() => setShowLoginModal(false)} onLoginWithGoogle={handleGoogleLogin} />}
              
              {showAdminPanel && (
                <AdminPanel 
                  userRole={userRole} 
                  userEmail={userEmail}
                  properties={properties} 
                  users={authorizedUsers}
                  companyInfo={companyInfo}
                  onClose={() => setShowAdminPanel(false)} 
                  onLogout={handleLogout}
                  appId={appId}
                  db={db}
                />
              )}
            </div>
          );
        }

        // --- Sale Page (Property Detail) ---
        function SalePage({ property, companyInfo, onBack }) {
          const [activeImg, setActiveImg] = useState(0);
          const images = property.images && property.images.length > 0 ? property.images : [property.imageUrl || "https://placehold.co/600x400"];
          const youtubeId = getYoutubeId(property.youtubeUrl);

          return (
            <div className="bg-stone-50 min-h-screen pb-12 animate-in fade-in zoom-in-95 duration-300">
              <div className="bg-white border-b sticky top-20 z-40 px-4 py-4 shadow-sm">
                 <div className="max-w-7xl mx-auto flex items-center gap-2">
                    <button onClick={onBack} className="flex items-center gap-1 text-stone-500 hover:text-[#116900] font-bold">
                       <ChevronLeft size={20} /> ย้อนกลับ
                    </button>
                    <span className="text-stone-300">|</span>
                    <span className="text-[#116900] font-bold truncate">{property.project_name}</span>
                 </div>
              </div>

              <div className="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-3 gap-8">
                 <div className="lg:col-span-2 space-y-8">
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-stone-200">
                       <div className="h-[400px] md:h-[500px] bg-stone-100 rounded-xl overflow-hidden mb-4 relative group">
                          <img src={images[activeImg]} className="w-full h-full object-cover transition duration-500" alt="Main" />
                          {images.length > 1 && (
                            <>
                              <button onClick={() => setActiveImg(prev => (prev === 0 ? images.length - 1 : prev - 1))} className="absolute left-4 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-[#116900] transition"><ChevronLeft /></button>
                              <button onClick={() => setActiveImg(prev => (prev === images.length - 1 ? 0 : prev + 1))} className="absolute right-4 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-[#116900] transition"><ChevronRight /></button>
                            </>
                          )}
                          {property.badge && (
                              <div className={`absolute top-4 left-4 px-3 py-1 rounded-lg font-bold shadow-lg z-10 text-white ${property.badge === 'Sold Out' ? 'bg-stone-800' : 'bg-red-600'}`}>
                                  {property.badge}
                              </div>
                          )}
                          {property.badge !== 'Sold Out' && (
                              <div className="absolute top-4 right-4 bg-[#116900] text-white px-4 py-2 rounded-lg font-bold shadow-lg text-lg">
                                {Number(property.price).toLocaleString()} บาท
                              </div>
                          )}
                       </div>
                       <div className="flex gap-2 overflow-x-auto pb-2">
                          {images.map((img, idx) => (
                            <button key={idx} onClick={() => setActiveImg(idx)} className={`w-20 h-20 flex-shrink-0 rounded-lg overflow-hidden border-2 ${activeImg === idx ? 'border-[#116900]' : 'border-transparent'}`}>
                               <img src={img} className="w-full h-full object-cover" alt={`Thumb ${idx}`} />
                            </button>
                          ))}
                       </div>
                    </div>

                    <div className="bg-white p-8 rounded-2xl shadow-sm border border-stone-200">
                       <div className="flex flex-wrap items-center gap-4 mb-6">
                          <span className="bg-[#116900]/10 text-[#116900] px-3 py-1 rounded-full text-sm font-bold">{property.category || 'บ้านมือสอง'}</span>
                          <span className="text-stone-500 text-sm flex items-center gap-1">
                              <MapPin size={14} /> 
                              {property.subdistrict && `ต.${property.subdistrict} `}
                              {property.district && `อ.${property.district} `}
                              {property.province && `จ.${property.province}`}
                          </span>
                       </div>
                       <h1 className="text-3xl md:text-4xl font-bold text-stone-800 mb-6">{property.project_name}</h1>

                       {/* New Detail Section with Price */}
                       <div className="bg-stone-50 p-6 rounded-xl mb-6 space-y-3 text-stone-700 text-lg">
                          <p className="flex items-center gap-2"><span className="font-bold w-32 flex-shrink-0">ชื่อโครงการ :</span> {property.project_name}</p>
                          <p className="flex items-center gap-2"><span className="font-bold w-32 flex-shrink-0">บ้านเลขที่ :</span> {property.house_number || '-'}</p>
                          <p className="flex items-center gap-2"><span className="font-bold w-32 flex-shrink-0">ซอย :</span> {property.soi || '-'}</p>
                          <p className="flex items-center gap-2"><span className="font-bold w-32 flex-shrink-0">ทิศ :</span> {property.direction || '-'}</p>
                          <div className="pt-2">
                            <div className="border-4 border-[#116900] rounded-xl p-4 bg-white shadow-sm inline-block min-w-[300px]">
                              <p className="text-sm text-stone-500 mb-1 font-bold">ราคาขาย</p>
                              <p className="text-4xl font-extrabold text-[#116900]">{Number(property.price).toLocaleString()} <span className="text-lg text-stone-600 font-normal">บาท</span></p>
                            </div>
                          </div>
                       </div>
                       
                       <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                           <div className="bg-stone-50 p-4 rounded-xl text-center">
                              <Maximize className="mx-auto text-[#116900] mb-2" />
                              <span className="block font-bold text-xl">{property.area_wah}</span>
                              <span className="text-xs text-stone-500">ตร.ว.</span>
                           </div>
                          <div className="bg-stone-50 p-4 rounded-xl text-center">
                              <Bed className="mx-auto text-[#116900] mb-2" />
                              <span className="block font-bold text-xl">{property.bedrooms}</span>
                              <span className="text-xs text-stone-500">ห้องนอน</span>
                           </div>
                          <div className="bg-stone-50 p-4 rounded-xl text-center">
                              <Bath className="mx-auto text-[#116900] mb-2" />
                              <span className="block font-bold text-xl">{property.bathrooms}</span>
                              <span className="text-xs text-stone-500">ห้องน้ำ</span>
                           </div>
                          <div className="bg-stone-50 p-4 rounded-xl text-center">
                              <Car className="mx-auto text-[#116900] mb-2" />
                              <span className="block font-bold text-xl">{property.parking}</span>
                              <span className="text-xs text-stone-500">ที่จอดรถ</span>
                           </div>
                       </div>

                       <h3 className="text-xl font-bold text-stone-800 mb-4 border-l-4 border-[#116900] pl-3">รายละเอียดทรัพย์สิน</h3>
                       <p className="text-stone-600 leading-relaxed whitespace-pre-line mb-8">{property.highlights || 'ไม่มีรายละเอียดเพิ่มเติม'}</p>

                       <h3 className="text-xl font-bold text-stone-800 mb-4 border-l-4 border-[#116900] pl-3">สิ่งอำนวยความสะดวก</h3>
                       <div className="flex flex-wrap gap-2 mb-8">
                          {property.facilitiesList && property.facilitiesList.length > 0 ? (
                            property.facilitiesList.map((fac, i) => (
                              <span key={i} className="flex items-center gap-2 bg-[#116900]/10 text-[#116900] px-3 py-1.5 rounded-lg text-sm">
                                <CheckCircle size={14} /> {fac}
                              </span>
                            ))
                          ) : (
                            <span className="text-stone-400">- ไม่ระบุ -</span>
                          )}
                       </div>

                       {youtubeId && (
                         <div className="mb-8">
                            <h3 className="text-xl font-bold text-stone-800 mb-4 border-l-4 border-[#116900] pl-3">วิดีโอแนะนำ</h3>
                            <div className="aspect-video rounded-xl overflow-hidden bg-black">
                               <iframe 
                                 width="100%" height="100%" 
                                 src={`https://www.youtube.com/embed/${youtubeId}?origin=${window.location.origin}`}
                                 title="YouTube video player" 
                                 frameBorder="0" 
                                 allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                 allowFullScreen
                               ></iframe>
                            </div>
                         </div>
                       )}

                       <h3 className="text-xl font-bold text-stone-800 mb-4 border-l-4 border-[#116900] pl-3">แผนที่</h3>
                       <div className="h-64 bg-stone-100 rounded-xl flex items-center justify-center text-stone-400">
                          {property.lat && property.lng ? (
                              <iframe 
                                width="100%" height="100%" frameBorder="0" style={{border:0}}
                                src={`https://maps.google.com/maps?q=${property.lat},${property.lng}&z=15&output=embed`}
                                allowFullScreen
                              ></iframe>
                           ) : (
                            <span>ไม่พบพิกัดแผนที่</span>
                          )}
                       </div>
                    </div>
                 </div>

                 <div className="space-y-6">
                    <div className="bg-white p-6 rounded-2xl shadow-lg border border-stone-200 sticky top-24">
                       <div className="flex items-center gap-4 mb-6 pb-6 border-b">
                          <div className="w-16 h-16 bg-white rounded-full overflow-hidden flex-shrink-0 border border-stone-200">
                              {companyInfo?.logoUrl ? <img src={companyInfo.logoUrl} className="w-full h-full object-cover" alt="Logo"/> : null}
                          </div>
                          <div>
                              <h3 className="font-bold text-lg">{companyInfo?.name || 'Startup Up Real Estate'}</h3>
                              <p className="text-sm text-stone-500">ตัวแทนขายอสังหาริมทรัพย์</p>
                          </div>
                       </div>
                       
                       <div className="space-y-4">
                          <a href={`tel:${companyInfo?.phone || '0624782426'}`} className="flex items-center justify-center gap-2 w-full bg-[#116900] text-white py-3 rounded-xl font-bold hover:bg-[#0d5200] transition shadow-lg shadow-[#116900]/30">
                              <Phone size={20} /> โทรติดต่อสอบถาม
                          </a>
                          <a href={companyInfo?.line} target="_blank" rel="noreferrer" className="flex items-center justify-center gap-2 w-full bg-[#06C755] text-white py-3 rounded-xl font-bold hover:bg-[#05a546] transition shadow-lg shadow-[#06C755]/30">
                              <MessageCircle size={20} /> ทักไลน์
                          </a>
                       </div>
                       
                       <div className="mt-8">
                         <CalculatorSection defaultPrice={property.price} />
                       </div>

                       <div className="mt-8 text-sm text-stone-500 space-y-2 pt-6 border-t">
                          <p className="flex items-start gap-2"><MapPin size={16} className="mt-1 flex-shrink-0" /> {companyInfo?.address}</p>
                       </div>
                    </div>
                 </div>
              </div>
            </div>
          );
        }

        // --- Page Sections ---

        function HomeSection({ properties, loading, onSelectProp, setActiveTab }) {
          const availableProps = properties.filter(p => p.badge !== 'Sold Out');
          const homeCategories = ['ทาวน์เฮาส์', 'บ้านแฝด', 'บ้านเดี่ยว'];

          return (
            <>
              <div className="relative bg-stone-900 overflow-hidden h-[400px] md:h-[500px]">
                <div className="absolute inset-0 opacity-60">
                    <img 
                     src="https://images.unsplash.com/photo-1564013799919-ab600027ffc6?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80" 
                     alt="Hero" className="w-full h-full object-cover"
                   />
                </div>
                <div className="relative max-w-7xl mx-auto px-4 h-full flex flex-col justify-center text-white">
                  <div className="max-w-3xl animate-in slide-in-from-bottom-10 duration-700">
                      <span className="bg-[#116900] text-white px-3 py-1 rounded-full text-sm font-bold uppercase tracking-wide mb-4 inline-block">
                        Best Choice
                      </span>
                      <h1 className="text-3xl md:text-5xl font-bold leading-tight mb-6">
                        ศูนย์รวมบ้านมือสอง <span className="bg-white/90 text-[#116900] px-2 rounded box-decoration-clone">คุณภาพเยี่ยม</span><br/>
                        โซนรังสิต - ปทุมธานี
                      </h1>
                      <button onClick={() => setActiveTab('promo')} className="bg-[#116900] hover:bg-[#0d5200] text-white px-8 py-3 rounded-lg font-bold transition shadow-lg shadow-[#116900]/50">
                        ดูรายการบ้านทั้งหมด
                      </button>
                  </div>
                </div>
              </div>

              <div className="max-w-7xl mx-auto px-4 py-12 space-y-16">
                {homeCategories.map((cat) => (
                  <CategoryCarousel 
                    key={cat} 
                    title={cat} 
                    properties={availableProps.filter(p => {
                        if (cat === 'ทาวน์เฮาส์') {
                            return p.category.includes('ทาวน์เฮาส์');
                        }
                        return p.category === cat;
                    })} 
                    onSelect={onSelectProp} 
                  />
                ))}
              </div>
            </>
          );
        }

        function CategoryCarousel({ title, properties, onSelect }) {
          const [page, setPage] = useState(0);
          const itemsPerPage = 3;
          const totalPages = Math.ceil(properties.length / itemsPerPage);
           
          const handlePrev = () => setPage(p => Math.max(0, p - 1));
          const handleNext = () => setPage(p => Math.min(totalPages - 1, p + 1));

          if (properties.length === 0) return null;

          const displayProps = properties.slice(page * itemsPerPage, (page + 1) * itemsPerPage);

          return (
            <div className="space-y-6">
               <div className="flex justify-between items-center px-2">
                  <h2 className="text-2xl font-bold text-stone-800 border-l-4 border-[#116900] pl-3">{title}</h2>
                  {totalPages > 1 && (
                     <div className="flex gap-2">
                        <button onClick={handlePrev} disabled={page === 0} className="p-2 rounded-full border hover:bg-stone-100 disabled:opacity-30"><ChevronLeft size={20}/></button>
                        <button onClick={handleNext} disabled={page === totalPages - 1} className="p-2 rounded-full border hover:bg-stone-100 disabled:opacity-30"><ChevronRight size={20}/></button>
                     </div>
                  )}
               </div>
               <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {displayProps.map(p => (
                     <PropertyCard key={p.id} data={p} onClick={() => onSelect(p)} />
                  ))}
               </div>
            </div>
          );
        }

        function PropertiesList({ properties, searchParams, onSelectProp }) {
          let displayProps = properties.filter(p => p.badge !== 'Sold Out');
          let title = 'รายการขายทั้งหมด';

          // Logic การกรอง
          if (searchParams?.type === 'promo') {
              displayProps = properties.filter(p => p.badge === 'Promotion');
              title = 'บ้านจัดโปรโมชั่น';
          } else if (searchParams?.type === 'district') {
              displayProps = properties.filter(p => p.district === searchParams.value || (p.subdistrict === 'คูคต' && searchParams.value === 'ลำลูกกา')); // Handle special case
              title = `ทำเล: ${searchParams.value}`;
          } else if (searchParams?.type === 'subdistrict') {
              // FIX: ไม่ตัดชื่ออำเภอออก เพื่อให้ค้นหาแบบ Full text หรือ context match ได้ถูกต้อง
              const keyword = searchParams.value.trim(); 
              displayProps = properties.filter(p => {
                // สร้าง search text ที่รวมทั้ง อำเภอ และ ตำบล
                const fullAddress = `${p.district} ${p.subdistrict} ${p.project_name} ${p.soi}`.toLowerCase();
                const searchText = keyword.toLowerCase();
                return fullAddress.includes(searchText) || p.highlights?.toLowerCase().includes(searchText);
              });
              title = `โซน: ${searchParams.value}`;
          }

          return (
            <div className="max-w-7xl mx-auto px-4 py-12">
              <h2 className="text-3xl font-bold text-stone-800 mb-8 flex items-center gap-3">
                <Home className="text-[#116900]" /> 
                {title}
              </h2>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                {displayProps.length > 0 ? displayProps.map(p => (
                  <PropertyCard key={p.id} data={p} onClick={() => onSelectProp(p)} />
                )) : <p className="text-stone-500 col-span-3 text-center py-10 bg-stone-50 rounded-xl">ไม่พบรายการในหมวดหมู่นี้</p>}
              </div>
            </div>
          );
        }

        function PropertyCard({ data, onClick }) {
          const img = (data.images && data.images.length > 0) ? data.images[0] : data.imageUrl;
           
          let displayLoc = data.subdistrict;
          if (displayLoc === 'คูคต') displayLoc = 'ลำลูกกา';

          return (
            <div onClick={onClick} className="bg-white rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-1 transition duration-300 cursor-pointer overflow-hidden border border-stone-100 flex flex-col h-full group">
              <div className="relative h-60 overflow-hidden bg-stone-200">
                <img 
                  src={img || "https://placehold.co/600x400?text=No+Image"} 
                  alt={data.project_name} 
                  className="w-full h-full object-cover group-hover:scale-105 transition duration-700"
                />
                {data.badge && (
                   <div className={`absolute top-4 left-4 px-3 py-1 rounded-lg font-bold shadow-lg z-10 text-xs text-white ${data.badge === 'Sold Out' ? 'bg-stone-800' : 'bg-red-600'}`}>
                      {data.badge}
                   </div>
                )}
                {data.badge !== 'Sold Out' && (
                   <div className="absolute top-4 right-4 bg-[#116900] text-white px-3 py-1 rounded-lg font-bold shadow-lg">
                     {Number(data.price).toLocaleString()} บาท
                   </div>
                )}
                <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-4">
                   <p className="text-white text-sm font-bold truncate">{data.project_name}</p>
                </div>
              </div>
               
              <div className="p-4 flex-grow flex flex-col">
                <div className="flex items-center justify-between mb-3">
                   <span className="text-xs bg-stone-100 text-stone-600 px-2 py-1 rounded-md">{data.category || 'บ้านมือสอง'}</span>
                   <span className="text-xs text-stone-400 flex items-center gap-1"><MapPin size={12} /> {displayLoc}</span>
                </div>
                
                <div className="grid grid-cols-3 gap-2 pt-3 border-t border-stone-100 mt-auto text-center text-stone-600 text-xs">
                  <div><span className="block font-bold text-stone-800 text-sm">{data.area_wah || '-'}</span> ตร.ว.</div>
                  <div><span className="block font-bold text-stone-800 text-sm">{data.bedrooms || '-'}</span> ห้องนอน</div>
                  <div><span className="block font-bold text-stone-800 text-sm">{data.bathrooms || '-'}</span> ห้องน้ำ</div>
                </div>
              </div>
            </div>
          );
        }

        function LocationSection({ onSelectLocation }) {
          return (
            <div className="max-w-7xl mx-auto px-4 py-12">
              <h2 className="text-3xl font-bold text-stone-800 mb-8 text-center">ทำเลยอดนิยม</h2>
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {LOCATIONS_DATA.map((loc, idx) => (
                  <div key={idx} onClick={() => onSelectLocation && onSelectLocation('district', loc.area)} className="bg-white rounded-2xl overflow-hidden shadow-lg border border-stone-100 group hover:shadow-xl transition cursor-pointer">
                    <div className="h-40 overflow-hidden relative">
                       <img 
                        src={loc.img} 
                        className="w-full h-full object-cover group-hover:scale-105 transition duration-700" 
                        alt={loc.area}
                      />
                      <div className="absolute inset-0 bg-black/40 flex items-center justify-center">
                         <h3 className="text-2xl font-bold text-white">{loc.area}</h3>
                      </div>
                    </div>
                    <div className="p-4">
                       <div className="flex flex-wrap gap-2">
                          {loc.sub_areas.map((sub, i) => (
                              <span 
                                key={i} 
                                onClick={(e) => { e.stopPropagation(); onSelectLocation && onSelectLocation('subdistrict', sub); }}
                                className="text-xs bg-stone-100 text-stone-600 px-2 py-1 rounded-md hover:bg-[#116900]/10 hover:text-[#116900] transition cursor-pointer"
                              >
                                {sub}
                              </span>
                          ))}
                       </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          );
        }

        function CalculatorSection({ defaultPrice }) {
          const [loanAmount, setLoanAmount] = useState(defaultPrice || '');
          const [interest, setInterest] = useState(3);
          const [age, setAge] = useState('');
          const [years, setYears] = useState(0); // FIX: Default to 0
          const [monthlyPayment, setMonthlyPayment] = useState(null);

          useEffect(() => {
            if (defaultPrice) {
               setLoanAmount(defaultPrice);
            }
          }, [defaultPrice]);

          useEffect(() => {
            if(age) {
               const maxTerm = Math.max(0, Math.min(40, 70 - parseInt(age)));
               setYears(maxTerm);
            } else {
               setYears(0); // Reset if no age
            }
          }, [age]);
           
          const handleCalculate = () => {
            if (years <= 0 || !loanAmount) {
               setMonthlyPayment(0);
               return;
            }
            const r = interest / 100 / 12;
            const n = years * 12;
            const payment = (Number(loanAmount) * r * Math.pow(1 + r, n)) / (Math.pow(1 + r, n) - 1);
            setMonthlyPayment(isNaN(payment) ? 0 : payment.toFixed(0));
          };

          return (
            <div className="max-w-4xl mx-auto">
              <div className="bg-white rounded-2xl shadow-xl p-8 border border-stone-200">
                <h2 className="text-2xl font-bold text-stone-800 mb-8 flex items-center gap-2"><Calculator className="text-[#116900]" /> คำนวณสินเชื่อ</h2>
                <div className="space-y-6">
                   <div className="grid grid-cols-2 gap-4">
                       <div><label className="block text-stone-600 mb-2 font-bold text-sm">วงเงินกู้ (บาท)</label><input type="number" value={loanAmount} onChange={e=>setLoanAmount(e.target.value)} className="w-full p-2 border rounded font-bold text-[#116900]" placeholder=""/></div>
                       <div><label className="block text-stone-600 mb-2 font-bold text-sm">ดอกเบี้ย (%)</label><input type="number" step="0.1" value={interest} onChange={e=>setInterest(Number(e.target.value))} className="w-full p-2 border rounded" placeholder=""/></div>
                   </div>
                   
                   <div className="grid grid-cols-2 gap-4">
                       <div><label className="block text-stone-600 mb-2 font-bold text-sm">อายุปัจจุบัน (ปี)</label><input type="number" min="20" max="70" value={age} onChange={e=>setAge(e.target.value)} className="w-full p-2 border rounded" placeholder=""/></div>
                       <div>
                          <label className="block text-stone-600 mb-2 font-bold text-sm">ระยะเวลาผ่อน (ปี)</label>
                          <div className={`w-full p-2 border rounded font-bold ${years > 0 ? 'bg-stone-100 text-stone-600' : 'bg-red-50 text-red-500'}`}>
                            {years > 0 ? `${years} ปี` : 'กรุณาใส่อายุ'}
                          </div>
                          <p className="text-[10px] text-stone-400 mt-1">*คำนวณอัตโนมัติ (สูงสุด 40 ปี)</p>
                       </div>
                   </div>

                   <button onClick={handleCalculate} className="btn-primary w-full justify-center py-3 text-lg mt-4">
                     คำนวณวงเงิน
                   </button>

                   <div className="bg-stone-50 rounded-xl p-6 text-center border border-stone-200 mt-4 min-h-[100px] flex flex-col justify-center">
                      {monthlyPayment !== null ? (
                         <>
                           <div className="text-stone-500 mb-1">ผ่อนชำระต่อเดือน (ประมาณ)</div>
                           <div className="text-3xl font-bold text-[#116900]">{Number(monthlyPayment).toLocaleString()}</div>
                           <div className="text-xs text-stone-400">บาท / เดือน</div>
                         </>
                      ) : (
                         <span className="text-stone-400 text-sm">กดปุ่มคำนวณเพื่อดูยอดผ่อน</span>
                      )}
                   </div>
                </div>
              </div>
            </div>
          );
        }

        function PortfolioSection({ companyInfo, properties }) {
          const soldOutProperties = properties.filter(p => p.badge === 'Sold Out');
          const portfolioYears = companyInfo?.portfolio_years || [];
          const oldPortfolioImages = companyInfo?.portfolio_images || [];

          return (
            <div className="max-w-7xl mx-auto px-4 py-16 text-center">
              <h2 className="text-3xl font-bold text-stone-800 mb-4">ผลงานของ {companyInfo?.name || 'บริษัท'}</h2>
               
              {soldOutProperties.length === 0 && oldPortfolioImages.length === 0 && portfolioYears.length === 0 && (
                 <p className="text-stone-400 mt-8">ยังไม่มีรายการผลงานในขณะนี้</p>
              )}

              {/* 1. แสดงบ้าน Sold Out จากระบบขาย */}
              {soldOutProperties.length > 0 && (
                <div className="mb-12">
                   <h3 className="text-xl font-bold text-stone-700 mb-6 text-left border-l-4 border-[#116900] pl-3">ขายแล้ว (Sold Out)</h3>
                   <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      {soldOutProperties.map(p => (
                        <div key={p.id} className="bg-white p-4 rounded-xl shadow border">
                           <div className="h-40 bg-stone-200 rounded mb-2 overflow-hidden relative">
                              <img src={p.images?.[0] || p.imageUrl} className="w-full h-full object-cover grayscale"/>
                              <div className="absolute inset-0 flex items-center justify-center bg-black/30 text-white font-bold text-xl uppercase tracking-wider">Sold Out</div>
                           </div>
                           <p className="font-bold text-stone-700 truncate">{p.project_name}</p>
                           <p className="text-xs text-stone-500">{p.subdistrict}</p>
                        </div>
                      ))}
                   </div>
                </div>
              )}
               
              {/* 2. แสดงผลงานรายปี (New Structure) */}
              {portfolioYears.length > 0 && portfolioYears.sort((a,b) => b.year - a.year).map((yearGroup, idx) => (
                 <div key={idx} className="mb-12">
                    <h3 className="text-xl font-bold text-stone-700 mb-6 text-left border-l-4 border-[#116900] pl-3">ผลงานปี {yearGroup.year}</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                       {yearGroup.images.map((img, i) => (
                          <div key={i} className="bg-white p-2 rounded-xl shadow border">
                              <div className="h-40 bg-stone-200 rounded overflow-hidden relative">
                                 <img src={img} className="w-full h-full object-cover"/>
                              </div>
                          </div>
                       ))}
                    </div>
                 </div>
              ))}

              {/* 3. Fallback for Old Structure */}
              {oldPortfolioImages.length > 0 && (
                 <div className="mb-12">
                   <h3 className="text-xl font-bold text-stone-700 mb-6 text-left border-l-4 border-[#116900] pl-3">ผลงานอื่นๆ</h3>
                   <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                     {oldPortfolioImages.map((img, idx) => (
                        <div key={`manual-${idx}`} className="bg-white p-4 rounded-xl shadow border">
                           <div className="h-40 bg-stone-200 rounded mb-2 overflow-hidden relative">
                              <img src={img} className="w-full h-full object-cover"/>
                           </div>
                           <p className="font-bold text-stone-700">ผลงานการขาย</p>
                        </div>
                     ))}
                   </div>
                 </div>
              )}
            </div>
          );
        }

        // --- Admin Panel ---

        function AdminPanel({ userRole, userEmail, properties, users, companyInfo, onClose, onLogout, appId, db }) {
          const [panelTab, setPanelTab] = useState('properties'); 
          const [isEditing, setIsEditing] = useState(false);
          const [editData, setEditData] = useState(null);
          const [searchTerm, setSearchTerm] = useState('');
           
          const [isSaving, setIsSaving] = useState(false);
          const [saveSuccess, setSaveSuccess] = useState(false);

          // Forms
          const initialForm = {
            project_name: '', category: 'ทาวน์เฮาส์', price: '', status: 'available', badge: '',
            house_number: '', soi: '', zipcode: '', subdistrict: '', district: '', province: '',
            area_wah: '', area_sqm: '', floors: '', bedrooms: '', bathrooms: '', parking: '',
            direction: '', lat: '', lng: '', highlights: '', facilitiesList: [], images: [], youtubeUrl: ''
          };
          const [formData, setFormData] = useState(initialForm);
          const [imagesPreview, setImagesPreview] = useState([]);
           
          // FIX: State for Address Dropdown Options
          const [addressOptions, setAddressOptions] = useState([]);

          // Company Form
          const [companyForm, setCompanyForm] = useState(companyInfo || DEFAULT_COMPANY_INFO);
           
          // Portfolio States
          const [newPortfolioYear, setNewPortfolioYear] = useState('');

          const [inviteEmail, setInviteEmail] = useState('');
          const [inviteRole, setInviteRole] = useState('admin');
          const [newFacility, setNewFacility] = useState('');

          useEffect(() => {
            if (companyInfo) {
              setCompanyForm(companyInfo);
            }
          }, [companyInfo]);

          const filteredProperties = properties.filter(p => p.project_name.toLowerCase().includes(searchTerm.toLowerCase()));

          const startEdit = (prop) => {
              setEditData(prop);
              setFormData({ ...initialForm, ...prop, facilitiesList: prop.facilitiesList || [] }); 
              setImagesPreview(prop.images || (prop.imageUrl ? [prop.imageUrl] : []));
              
              // Initialize address options if zip exists
              if (prop.zipcode && THAI_ADDRESS_DB[prop.zipcode]) {
                setAddressOptions(THAI_ADDRESS_DB[prop.zipcode]);
              } else {
                setAddressOptions([]);
              }
              
              setIsEditing(true);
          };

          const startNew = () => {
            setEditData(null); setFormData(initialForm); setImagesPreview([]); setAddressOptions([]); setIsEditing(true);
          };

          const handleZipcodeChange = (e) => {
            const code = e.target.value;
            setFormData(prev => ({ ...prev, zipcode: code }));
              
            // FIX: Show options instead of auto-setting immediately
            if (THAI_ADDRESS_DB[code]) {
              setAddressOptions(THAI_ADDRESS_DB[code]);
              // Optional: Auto-select first if only one option
              if (THAI_ADDRESS_DB[code].length === 1) {
                 const addr = THAI_ADDRESS_DB[code][0];
                 setFormData(prev => ({
                   ...prev,
                   zipcode: code,
                   subdistrict: addr.subdistrict,
                   district: addr.district,
                   province: addr.province,
                 }));
              } else {
                 // Reset selected if multiple choices to force selection
                 setFormData(prev => ({ ...prev, zipcode: code, subdistrict: '', district: '', province: '' }));
              }
            } else {
              setAddressOptions([]);
            }
          };

          // FIX: Handler for selecting specific address
          const handleAddressSelect = (e) => {
            const index = e.target.value;
            if (index === "") return;
            const addr = addressOptions[index];
            setFormData(prev => ({
              ...prev,
              subdistrict: addr.subdistrict,
              district: addr.district,
              province: addr.province,
            }));
          };

          const handleImageUpload = async (e) => {
            const files = Array.from(e.target.files);
            if (files.length + imagesPreview.length > 10) {
              alert('อัปโหลดได้สูงสุด 10 รูป');
              return;
            }
            const newImages = [];
            for (const file of files) {
               const base64 = await resizeImage(file);
               newImages.push(base64);
            }
            const updated = [...imagesPreview, ...newImages];
            setImagesPreview(updated);
            setFormData(prev => ({ ...prev, images: updated }));
          };

          const removeImage = (idx) => {
            const updated = imagesPreview.filter((_, i) => i !== idx);
            setImagesPreview(updated);
            setFormData(prev => ({ ...prev, images: updated }));
          };
           
          const handleFacilityChange = (e) => {
            const val = e.target.value;
            if (val && !formData.facilitiesList?.includes(val)) {
               setFormData(prev => ({ ...prev, facilitiesList: [...(prev.facilitiesList || []), val] }));
            }
          };
           
          const addCustomFacility = () => {
             if(newFacility && !formData.facilitiesList?.includes(newFacility)) {
                setFormData(prev => ({ ...prev, facilitiesList: [...(prev.facilitiesList || []), newFacility] }));
                setNewFacility('');
             }
          };
           
          const removeFacility = (fac) => {
            setFormData(prev => ({ ...prev, facilitiesList: prev.facilitiesList.filter(f => f !== fac) }));
          };

          const handleSaveProperty = async (e) => {
            e.preventDefault();
            setIsSaving(true);
            try {
              const lat = formData.lat ? formData.lat.trim().replace(',', '') : '';
              const lng = formData.lng ? formData.lng.trim().replace(',', '') : '';
              const facilitiesList = Array.isArray(formData.facilitiesList) ? formData.facilitiesList : [];
              
              // --- Logic: อัปโหลดรูปที่เป็น Base64 ขึ้น Storage ---
              const finalImages = [];
              if (formData.images && formData.images.length > 0) {
                for (const img of formData.images) {
                  if (typeof img === 'string' && img.startsWith('data:')) {
                    // ถ้ารูปเป็น Base64 (รูปใหม่) ให้อัปโหลด
                    const url = await uploadBase64ToStorage(img);
                    finalImages.push(url);
                  } else {
                    // ถ้าเป็น URL อยู่แล้ว (รูปเก่า) ให้ใช้ค่าเดิม
                    finalImages.push(img);
                  }
                }
              }

              const dataToSave = { ...formData, images: finalImages, lat, lng, facilitiesList };
              
              if (editData) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', editData.id), dataToSave);
              else await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'properties'), { ...dataToSave, createdAt: serverTimestamp() });
              
              setIsSaving(false);
              setSaveSuccess(true);
            } catch (err) { 
                setIsSaving(false);
                console.error(err);
                alert("เกิดข้อผิดพลาด: " + err.message); 
            }
          };

          const closeSuccessOverlay = () => {
            setSaveSuccess(false);
            setIsEditing(false); 
            setEditData(null); 
            setFormData(initialForm);
            setImagesPreview([]);
          };

          const handleDeleteProperty = async (id) => {
            if (!id) {
                alert('เกิดข้อผิดพลาด: ไม่พบ ID ของรายการนี้');
                return;
            }
              
            if (window.confirm('คุณแน่ใจหรือไม่ที่จะลบรายการนี้? การกระทำนี้ไม่สามารถย้อนกลับได้')) {
                try {
                    setIsSaving(true);
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'properties', id));
                    setIsSaving(false);
                    alert('ลบรายการเรียบร้อยแล้ว');
                } catch (error) {
                    setIsSaving(false);
                    alert('เกิดข้อผิดพลาดในการลบ: ' + error.message);
                }
            }
          };

          const handleSaveCompany = async (e) => {
            e.preventDefault();
            setIsSaving(true);
            
            // --- Logic: อัปโหลด Logo ถ้าเป็น Base64 ---
            let newLogoUrl = companyForm.logoUrl;
            if (newLogoUrl && newLogoUrl.startsWith('data:')) {
                newLogoUrl = await uploadBase64ToStorage(newLogoUrl);
            }

            const companyDataToSave = { ...companyForm, logoUrl: newLogoUrl };

            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'company_info', 'main'), companyDataToSave);
            
            // Update State local เพื่อให้เห็น Logo ใหม่ทันที
            setCompanyForm(companyDataToSave);
            
            setIsSaving(false);
            setSaveSuccess(true);
          };

          const handleCompanyLogo = async (e) => {
             const file = e.target.files[0];
             if(file) {
               const base64 = await resizeImage(file);
               setCompanyForm(prev => ({...prev, logoUrl: base64}));
             }
          };

          // --- Portfolio Functions ---

          const handleAddYear = () => {
            if(!newPortfolioYear) return;
            const currentYears = companyForm.portfolio_years || [];
            if(currentYears.find(y => y.year === newPortfolioYear)) {
              alert('มีปีนี้อยู่แล้ว');
              return;
            }
            setCompanyForm({
              ...companyForm,
              portfolio_years: [...currentYears, { year: newPortfolioYear, images: [] }]
            });
            setNewPortfolioYear('');
          };

          const handleDeleteYear = (year) => {
            if(confirm(`ลบข้อมูลปี ${year} และรูปทั้งหมด?`)) {
               setCompanyForm({
                 ...companyForm,
                 portfolio_years: companyForm.portfolio_years.filter(y => y.year !== year)
               });
            }
          };

          const handlePortfolioImagesUpload = async (e, yearIndex) => {
             const files = Array.from(e.target.files);
             if(files.length === 0) return;

             setIsSaving(true);
             const newImages = [];
             for(const file of files) {
               const base64 = await resizeImage(file);
               newImages.push(base64);
             }
             setIsSaving(false);

             const updatedYears = [...(companyForm.portfolio_years || [])];
             updatedYears[yearIndex].images = [...updatedYears[yearIndex].images, ...newImages];
             
             setCompanyForm({ ...companyForm, portfolio_years: updatedYears });
          };

          const removePortfolioImageInYear = (yearIndex, imgIndex) => {
            const updatedYears = [...companyForm.portfolio_years];
            updatedYears[yearIndex].images = updatedYears[yearIndex].images.filter((_, i) => i !== imgIndex);
            setCompanyForm({ ...companyForm, portfolio_years: updatedYears });
          };

          const handleSavePortfolio = async () => {
             setIsSaving(true);
             
             // --- Logic: Loop through years and upload Base64 images ---
             const updatedYears = [];
             if (companyForm.portfolio_years && companyForm.portfolio_years.length > 0) {
                for (const yearGroup of companyForm.portfolio_years) {
                    const uploadedImages = [];
                    for (const img of yearGroup.images) {
                        if (typeof img === 'string' && img.startsWith('data:')) {
                            const url = await uploadBase64ToStorage(img);
                            uploadedImages.push(url);
                        } else {
                            uploadedImages.push(img);
                        }
                    }
                    updatedYears.push({ ...yearGroup, images: uploadedImages });
                }
             }
             
             const dataToSave = { ...companyForm, portfolio_years: updatedYears };

             await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'company_info', 'main'), dataToSave);
             setCompanyForm(dataToSave); // Update state with new URLs
             
             setIsSaving(false);
             setSaveSuccess(true);
          };
           
          const handleAddUser = async (e) => {
            e.preventDefault();
            if (!inviteEmail) return;
            try {
              await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', inviteEmail), {
                email: inviteEmail.toLowerCase().trim(),
                role: inviteRole,
                addedBy: userEmail,
                createdAt: serverTimestamp()
              });
              setInviteEmail('');
              alert('เพิ่มผู้ใช้งานเรียบร้อย');
            } catch (err) { alert("Error: " + err.message); }
          };

          const handleRemoveUser = async (id) => {
            if(confirm('ยืนยันการลบสิทธิ์ผู้ใช้นี้?')) {
              await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id));
            }
          };

          return (
            <div className="fixed inset-0 z-[60] bg-stone-100 flex flex-col overflow-hidden">
              {/* Saving Overlay */}
              {isSaving && (
                 <div className="absolute inset-0 z-[100] bg-black/60 flex flex-col items-center justify-center text-white backdrop-blur-sm animate-in fade-in">
                     <Loader size={48} className="animate-spin mb-4"/>
                     <h3 className="text-xl font-bold">กำลังบันทึกข้อมูล...</h3>
                     <p className="text-sm mt-2 opacity-80">กำลังอัปโหลดรูปภาพขึ้น Cloud Storage</p>
                 </div>
              )}
              
              {/* Success Overlay */}
              {saveSuccess && (
                 <div className="absolute inset-0 z-[100] bg-black/60 flex flex-col items-center justify-center text-white backdrop-blur-sm animate-in fade-in">
                     <div className="bg-white p-8 rounded-2xl shadow-2xl text-center max-w-sm w-full mx-4">
                        <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4">
                           <Check size={40} strokeWidth={3} />
                        </div>
                        <h3 className="text-xl font-bold text-stone-800 mb-2">บันทึกสำเร็จ!</h3>
                        <p className="text-stone-500 mb-6">ข้อมูลถูกอัปเดตลงในระบบเรียบร้อยแล้ว</p>
                        <button onClick={closeSuccessOverlay} className="btn-primary w-full justify-center">ตกลง</button>
                     </div>
                 </div>
              )}

              <div className="bg-stone-900 text-white px-6 py-4 flex justify-between items-center shadow-md">
                <div className="flex items-center gap-4">
                  <div className="w-10 h-10 bg-white text-[#116900] rounded-full flex items-center justify-center font-bold">{userRole === 'host' ? 'H' : 'A'}</div>
                  <div><h2 className="font-bold text-lg">ระบบหลังบ้าน</h2><p className="text-xs text-stone-400">By: {userEmail}</p></div>
                </div>
                <div className="flex gap-3"><button onClick={onClose} className="text-stone-300">กลับหน้าเว็บ</button><button onClick={onLogout} className="bg-red-600 px-3 py-1 rounded">ออกจากระบบ</button></div>
              </div>

              <div className="flex flex-1 overflow-hidden">
                <div className="w-64 bg-white border-r flex flex-col">
                  <button onClick={() => { setPanelTab('properties'); setIsEditing(false); }} className={`p-4 text-left font-medium border-b flex items-center gap-2 ${panelTab === 'properties' ? 'bg-[#116900]/10 text-[#116900]' : ''}`}><Home size={18}/> จัดการบ้าน</button>
                  {userRole === 'host' && <button onClick={() => setPanelTab('company')} className={`p-4 text-left font-medium border-b flex items-center gap-2 ${panelTab === 'company' ? 'bg-[#116900]/10 text-[#116900]' : ''}`}><Briefcase size={18}/> ข้อมูลบริษัท</button>}
                  {userRole === 'host' && <button onClick={() => setPanelTab('portfolio_images')} className={`p-4 text-left font-medium border-b flex items-center gap-2 ${panelTab === 'portfolio_images' ? 'bg-[#116900]/10 text-[#116900]' : ''}`}><ImageIcon size={18}/> จัดการรูปผลงาน</button>}
                  {userRole === 'host' && <button onClick={() => setPanelTab('users')} className={`p-4 text-left font-medium border-b flex items-center gap-2 ${panelTab === 'users' ? 'bg-[#116900]/10 text-[#116900]' : ''}`}><Users size={18}/> ผู้ดูแลระบบ</button>}
                </div>

                <div className="flex-1 p-8 overflow-y-auto bg-stone-100">
                  {panelTab === 'properties' && !isEditing && (
                    <div className="max-w-6xl mx-auto">
                      <div className="flex justify-between mb-6">
                        <h3 className="text-2xl font-bold">รายการทรัพย์สิน</h3>
                        <div className="flex gap-2">
                           <input type="text" placeholder="ค้นหา..." className="border rounded px-3 py-1" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/>
                           <button onClick={startNew} className="btn-primary"><Plus size={18}/> เพิ่มบ้านใหม่</button>
                        </div>
                      </div>
                      <div className="space-y-4">
                         {filteredProperties.map(p => (
                            <div key={p.id} className="bg-white p-4 rounded-xl shadow flex gap-4 items-center">
                               <div className="w-24 h-24 bg-stone-200 rounded overflow-hidden flex-shrink-0 relative">
                                  <img src={p.images?.[0] || p.imageUrl || "https://placehold.co/200"} className="w-full h-full object-cover"/>
                                  {p.badge && <span className={`absolute top-0 left-0 text-white text-[10px] px-2 py-0.5 ${p.badge==='Sold Out'?'bg-stone-800':'bg-red-600'}`}>{p.badge}</span>}
                               </div>
                               <div className="flex-1">
                                  <h4 className="font-bold">{p.project_name}</h4>
                                  <p className="text-xs text-stone-500">{p.category} | {p.subdistrict}</p>
                                  <p className="font-bold text-[#116900]">{Number(p.price).toLocaleString()} บ.</p>
                               </div>
                               <div className="flex gap-2">
                                  <button onClick={() => startEdit(p)} className="p-2 bg-stone-100 rounded hover:bg-blue-100"><Edit size={16}/></button>
                                  <button onClick={() => handleDeleteProperty(p.id)} className="p-2 bg-stone-100 rounded hover:bg-red-100"><Trash2 size={16}/></button>
                               </div>
                            </div>
                         ))}
                      </div>
                    </div>
                  )}

                  {panelTab === 'properties' && isEditing && (
                    <div className="max-w-7xl mx-auto">
                      <div className="flex justify-between mb-6 border-b pb-4">
                        <h3 className="text-2xl font-bold">{editData ? 'แก้ไข' : 'เพิ่มใหม่'}</h3>
                        <div className="flex gap-2">
                           <button onClick={()=>setIsEditing(false)} className="px-4 py-2 hover:bg-stone-200 rounded">ยกเลิก</button>
                           <button onClick={handleSaveProperty} className="btn-primary"><Save size={18}/> บันทึก</button>
                        </div>
                      </div>

                      <form className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                         <div className="lg:col-span-2 space-y-6">
                            <div className="bg-white p-6 rounded shadow">
                               <h4 className="font-bold mb-4 flex items-center gap-2"><FileText size={20}/> ข้อมูลหลัก</h4>
                               <div className="grid grid-cols-2 gap-4">
                                  <div className="col-span-2"><label className="label">ชื่อโครงการ</label><input className="input-modern" value={formData.project_name} onChange={e=>setFormData({...formData, project_name: e.target.value})} placeholder=""/></div>
                                  <div><label className="label">ประเภท</label><select className="input-modern" value={formData.category} onChange={e=>setFormData({...formData, category: e.target.value})}>{CATEGORIES.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                  <div><label className="label">ราคา (บาท)</label><input type="number" className="input-modern font-bold text-[#116900]" value={formData.price} onChange={e=>setFormData({...formData, price: e.target.value})} placeholder=""/></div>
                                  
                                  <div className="col-span-2">
                                     <label className="label flex items-center gap-2"><Tag size={16}/> ป้ายสถานะ (Badge)</label>
                                     <select className="input-modern bg-stone-50" value={formData.badge} onChange={e=>setFormData({...formData, badge: e.target.value})}>
                                        {BADGES.map(b => <option key={b.value} value={b.value}>{b.label}</option>)}
                                     </select>
                                     <p className="text-xs text-stone-500 mt-1">* เลือก Sold Out จะย้ายไปหน้าผลงานบริษัท, Promotion ย้ายไปหน้าโปรโมชั่น</p>
                                  </div>
                               </div>
                               <div className="mt-4"><label className="label">จุดเด่น</label><textarea rows="3" className="input-modern" value={formData.highlights} onChange={e=>setFormData({...formData, highlights: e.target.value})} placeholder=""/></div>
                               <div className="mt-4"><label className="label flex items-center gap-2"><Youtube size={16}/> ลิงก์ YouTube (Video)</label><input placeholder="" className="input-modern" value={formData.youtubeUrl} onChange={e=>setFormData({...formData, youtubeUrl: e.target.value})}/></div>
                            </div>

                            <div className="bg-white p-6 rounded shadow">
                               <h4 className="font-bold mb-4 flex items-center gap-2"><Layout size={20}/> รายละเอียด</h4>
                               <div className="grid grid-cols-3 gap-4">
                                  <div className="col-span-1"><label className="label">บ้านเลขที่</label><input className="input-modern" placeholder="" value={formData.house_number} onChange={e=>setFormData({...formData, house_number: e.target.value})}/></div>
                                  <div className="col-span-1"><label className="label">ซอย</label><input className="input-modern" placeholder="" value={formData.soi} onChange={e=>setFormData({...formData, soi: e.target.value})}/></div>
                                  <div className="col-span-1">
                                     <label className="label">ทิศ</label>
                                     <select className="input-modern" value={formData.direction} onChange={e=>setFormData({...formData, direction: e.target.value})}>
                                        <option value="">- เลือกทิศ -</option>
                                        {DIRECTIONS.map(d => <option key={d} value={d}>{d}</option>)}
                                     </select>
                                  </div>
                                  
                                  <div className="col-span-1"><label className="label">ห้องนอน</label><input type="number" className="input-modern" placeholder="" value={formData.bedrooms} onChange={e=>setFormData({...formData, bedrooms: e.target.value})}/></div>
                                  <div className="col-span-1"><label className="label">ห้องน้ำ</label><input type="number" className="input-modern" placeholder="" value={formData.bathrooms} onChange={e=>setFormData({...formData, bathrooms: e.target.value})}/></div>
                                  <div className="col-span-1"><label className="label">จำนวนชั้น</label><input type="number" className="input-modern" placeholder="" value={formData.floors} onChange={e=>setFormData({...formData, floors: e.target.value})}/></div>
                                  <div className="col-span-1"><label className="label">ตร.ว.</label><input className="input-modern" placeholder="" value={formData.area_wah} onChange={e=>setFormData({...formData, area_wah: e.target.value})}/></div>
                                  <div className="col-span-1"><label className="label">ตร.ม.</label><input className="input-modern" placeholder="" value={formData.area_sqm} onChange={e=>setFormData({...formData, area_sqm: e.target.value})}/></div>
                                  <div className="col-span-1"><label className="label">จอดรถ</label><input className="input-modern" placeholder="" value={formData.parking} onChange={e=>setFormData({...formData, parking: e.target.value})}/></div>
                               </div>
                            </div>

                            <div className="bg-white p-6 rounded shadow">
                               <h4 className="font-bold mb-4 flex items-center gap-2"><CheckCircle size={20}/> สิ่งอำนวยความสะดวก</h4>
                               <div className="flex gap-2 mb-2 items-center">
                                  <div className="flex-1">
                                     <select className="input-modern" value="" onChange={handleFacilityChange}>
                                        <option value="">- เลือกจากรายการ -</option>
                                        {COMMON_FACILITIES.map(f => <option key={f} value={f}>{f}</option>)}
                                     </select>
                                  </div>
                                  <div className="text-sm text-stone-400">หรือ</div>
                                  <div className="flex flex-1 gap-1">
                                    <input className="input-modern" placeholder="" value={newFacility} onChange={e=>setNewFacility(e.target.value)}/>
                                    <button type="button" onClick={addCustomFacility} className="bg-[#116900] text-white px-3 rounded"><Plus size={16}/></button>
                                  </div>
                               </div>
                               
                               <div className="flex flex-wrap gap-2 mt-4">
                                  {(formData.facilitiesList || []).map((fac, i) => (
                                     <span key={i} className="px-3 py-1 rounded-full text-sm border bg-[#116900] text-white flex items-center gap-1 shadow-sm">
                                        {fac} <button type="button" onClick={()=>removeFacility(fac)} className="hover:text-red-300"><XCircle size={14}/></button>
                                     </span>
                                  ))}
                                  {(!formData.facilitiesList || formData.facilitiesList.length === 0) && <span className="text-stone-400 text-sm">ยังไม่ได้เลือก</span>}
                               </div>
                            </div>
                         </div>

                         <div className="space-y-6">
                            <div className="bg-white p-6 rounded shadow">
                               <h4 className="font-bold mb-4">รูปภาพ ({imagesPreview.length}/10)</h4>
                               <div className="grid grid-cols-3 gap-2 mb-4">
                                  {imagesPreview.map((img, i) => (
                                     <div key={i} className="relative aspect-square bg-stone-100 rounded overflow-hidden group">
                                        <img src={img} className="w-full h-full object-cover"/>
                                        <button type="button" onClick={()=>removeImage(i)} className="absolute top-1 right-1 bg-red-500 text-white p-1 rounded-full opacity-0 group-hover:opacity-100"><X size={12}/></button>
                                     </div>
                                  ))}
                                  {imagesPreview.length < 10 && (
                                     <label className="aspect-square flex flex-col items-center justify-center border-2 border-dashed rounded cursor-pointer hover:bg-stone-50">
                                        <Upload size={20} className="text-stone-400"/>
                                        <span className="text-xs text-stone-500 mt-1">เพิ่มรูป</span>
                                        <input type="file" multiple accept="image/*" className="hidden" onChange={handleImageUpload}/>
                                     </label>
                                  )}
                               </div>
                            </div>

                            <div className="bg-white p-6 rounded shadow">
                               <h4 className="font-bold mb-4">ที่ตั้ง</h4>
                               <div className="space-y-3">
                                  <div>
                                    <label className="label">รหัสไปรษณีย์</label>
                                    <input className="input-modern border-[#116900]" placeholder="" value={formData.zipcode} onChange={handleZipcodeChange}/>
                                  </div>
                                  
                                  {/* FIX: Add Dropdown for Subdistrict Selection */}
                                  {addressOptions.length > 1 && (
                                    <div className="animate-in fade-in slide-in-from-top-2">
                                       <label className="label text-[#116900]">เลือกตำบล/แขวง (พบ {addressOptions.length} รายการ)</label>
                                       <select className="input-modern border-[#116900] bg-green-50" onChange={handleAddressSelect} defaultValue="">
                                         <option value="" disabled>-- กรุณาเลือก --</option>
                                         {addressOptions.map((opt, idx) => (
                                            <option key={idx} value={idx}>
                                                {opt.subdistrict} - {opt.district}
                                            </option>
                                         ))}
                                       </select>
                                    </div>
                                  )}

                                  <div>
                                     <label className="label">ตำบล</label>
                                     <input className="input-modern bg-stone-50" readOnly value={formData.subdistrict} placeholder=""/>
                                  </div>
                                  <div>
                                     <label className="label">อำเภอ</label>
                                     <input className="input-modern bg-stone-50" readOnly value={formData.district} placeholder=""/>
                                  </div>
                                  <div>
                                     <label className="label">จังหวัด</label>
                                     <input className="input-modern bg-stone-50" readOnly value={formData.province} placeholder=""/>
                                  </div>
                                  <div className="pt-4 border-t mt-2">
                                    <label className="block text-sm font-bold text-stone-700 mb-2">พิกัดแผนที่ (Google Maps)</label>
                                    <div className="grid grid-cols-2 gap-2">
                                       <input className="input-modern" placeholder="Lat" value={formData.lat} onChange={e => setFormData({...formData, lat: e.target.value})}/>
                                       <input className="input-modern" placeholder="Lng" value={formData.lng} onChange={e => setFormData({...formData, lng: e.target.value})}/>
                                    </div>
                                    <p className="text-xs text-stone-400 mt-1">* ระบบจะตัดช่องว่างให้อัตโนมัติ</p>
                                  </div>
                               </div>
                            </div>
                         </div>
                      </form>
                    </div>
                  )}

                  {panelTab === 'company' && (
                     <div className="max-w-2xl mx-auto bg-white p-8 rounded shadow">
                        <h3 className="text-xl font-bold mb-6 flex items-center gap-2"><Briefcase/> ข้อมูลบริษัท (Global)</h3>
                        <form onSubmit={handleSaveCompany} className="space-y-4">
                           <div className="flex items-center gap-4">
                              <div className="w-20 h-20 bg-stone-200 rounded-full overflow-hidden relative group">
                                 <img src={companyForm.logoUrl || "https://placehold.co/100"} className="w-full h-full object-cover"/>
                                 <label className="absolute inset-0 bg-black/50 flex items-center justify-center text-white opacity-0 group-hover:opacity-100 cursor-pointer text-xs text-center p-1">
                                   เปลี่ยน<input type="file" className="hidden" onChange={handleCompanyLogo}/>
                                 </label>
                              </div>
                              <div className="flex-1"><label className="label">ชื่อบริษัท</label><input className="input-modern" value={companyForm.name} onChange={e=>setCompanyForm({...companyForm, name: e.target.value})}/></div>
                           </div>
                           <div><label className="label">ที่อยู่</label><textarea className="input-modern" value={companyForm.address} onChange={e=>setCompanyForm({...companyForm, address: e.target.value})}/></div>
                           <div className="grid grid-cols-2 gap-4">
                              <div><label className="label">เบอร์โทร</label><input className="input-modern" value={companyForm.phone} onChange={e=>setCompanyForm({...companyForm, phone: e.target.value})}/></div>
                              <div><label className="label">Line ID / Link</label><input className="input-modern" value={companyForm.line} onChange={e=>setCompanyForm({...companyForm, line: e.target.value})}/></div>
                              <div><label className="label">Facebook Link</label><input className="input-modern" value={companyForm.facebook} onChange={e=>setCompanyForm({...companyForm, facebook: e.target.value})}/></div>
                              <div><label className="label">Email</label><input className="input-modern" value={companyForm.email} onChange={e=>setCompanyForm({...companyForm, email: e.target.value})}/></div>
                           </div>
                           <div><label className="label">คำอธิบายสั้นๆ</label><textarea className="input-modern" value={companyForm.description} onChange={e=>setCompanyForm({...companyForm, description: e.target.value})}/></div>
                           <button className="btn-primary w-full"><Save size={18}/> บันทึกข้อมูลบริษัท</button>
                        </form>
                     </div>
                  )}

                  {panelTab === 'portfolio_images' && (
                     <div className="max-w-5xl mx-auto">
                        <div className="flex justify-between items-center mb-6">
                          <h3 className="text-xl font-bold flex items-center gap-2"><ImageIcon/> จัดการรูปผลงาน (Portfolio)</h3>
                          <button onClick={handleSavePortfolio} className="btn-primary px-6"><Save size={18}/> บันทึกการเปลี่ยนแปลง</button>
                        </div>
                        
                        {/* Add New Year */}
                        <div className="bg-white p-6 rounded shadow mb-6 border border-stone-200">
                           <h4 className="font-bold mb-4 flex items-center gap-2"><FolderPlus size={20}/> สร้างหมวดหมู่ปี</h4>
                           <div className="flex gap-3">
                              <input 
                                 type="number" 
                                 className="input-modern max-w-[200px]" 
                                 placeholder="" 
                                 value={newPortfolioYear} 
                                 onChange={e => setNewPortfolioYear(e.target.value)}
                              />
                              <button onClick={handleAddYear} className="bg-stone-800 text-white px-4 rounded hover:bg-stone-900 font-bold">สร้างปี</button>
                           </div>
                        </div>

                        {/* List Years */}
                        <div className="space-y-8">
                          {(!companyForm.portfolio_years || companyForm.portfolio_years.length === 0) && (
                             <p className="text-center text-stone-400 py-10 bg-stone-50 rounded">ยังไม่มีข้อมูลผลงานรายปี</p>
                          )}

                          {companyForm.portfolio_years?.sort((a,b) => b.year - a.year).map((yearGroup, yearIndex) => (
                            <div key={yearGroup.year} className="bg-white p-6 rounded shadow border border-stone-200">
                               <div className="flex justify-between items-center mb-4 border-b pb-2">
                                  <h4 className="text-xl font-bold text-[#116900] flex items-center gap-2"><Calendar size={20}/> ผลงานปี {yearGroup.year}</h4>
                                  <button onClick={() => handleDeleteYear(yearGroup.year)} className="text-red-500 hover:text-red-700 text-sm flex items-center gap-1"><Trash2 size={16}/> ลบปีนี้</button>
                               </div>

                               <div className="mb-4">
                                  <label className="cursor-pointer inline-flex items-center gap-2 bg-stone-100 hover:bg-stone-200 px-4 py-2 rounded text-stone-700 font-medium transition">
                                     <Upload size={18}/> อัปโหลดรูปภาพ (เลือกได้หลายรูป)
                                     <input 
                                       type="file" 
                                       multiple 
                                       accept="image/*" 
                                       className="hidden" 
                                       onChange={(e) => handlePortfolioImagesUpload(e, yearIndex)}
                                     />
                                  </label>
                               </div>

                               <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                  {yearGroup.images.map((img, imgIndex) => (
                                     <div key={imgIndex} className="relative aspect-square bg-stone-100 rounded overflow-hidden group border">
                                        <img src={img} className="w-full h-full object-cover"/>
                                        <button 
                                          onClick={() => removePortfolioImageInYear(yearIndex, imgIndex)}
                                          className="absolute top-1 right-1 bg-red-600 text-white p-1.5 rounded-full opacity-0 group-hover:opacity-100 transition shadow-sm"
                                        >
                                          <Trash2 size={14}/>
                                        </button>
                                     </div>
                                  ))}
                                  {yearGroup.images.length === 0 && (
                                     <div className="col-span-full text-center py-8 text-stone-400 border-2 border-dashed rounded bg-stone-50">
                                        ยังไม่มีรูปภาพในหมวดนี้
                                     </div>
                                  )}
                               </div>
                            </div>
                          ))}
                        </div>
                     </div>
                  )}
                  
                  {panelTab === 'users' && (
                     <div className="max-w-2xl mx-auto bg-white p-8 rounded shadow">
                       <h3 className="font-bold text-xl text-[#116900] mb-6 flex items-center gap-2"><ShieldCheck /> เพิ่มสิทธิ์ผู้ใช้งาน</h3>
                         <form onSubmit={handleAddUser} className="flex gap-4 items-end mb-8">
                           <div className="flex-1">
                             <label className="block text-sm font-medium text-stone-700 mb-1">อีเมลผู้ใช้งาน</label>
                             <input required type="email" placeholder="" className="w-full p-2 border rounded-lg" value={inviteEmail} onChange={e => setInviteEmail(e.target.value)}/>
                           </div>
                           <div className="w-40">
                             <label className="block text-sm font-medium text-stone-700 mb-1">สิทธิ์การใช้งาน</label>
                             <select className="w-full p-2 border rounded-lg" value={inviteRole} onChange={e => setInviteRole(e.target.value)}>
                               <option value="admin">Admin (ผู้ดูแล)</option>
                               <option value="host">Host (เจ้าของ)</option>
                             </select>
                           </div>
                           <button type="submit" className="bg-[#116900] text-white px-6 py-2.5 rounded-lg font-bold">เพิ่ม</button>
                         </form>

                         <h3 className="font-bold text-xl mb-4">รายชื่อผู้มีสิทธิ์ใช้งาน</h3>
                         <div className="bg-white rounded-xl shadow-sm border overflow-hidden">
                            {users.length === 0 ? <div className="p-8 text-center text-stone-400">ยังไม่มีผู้ใช้งานอื่น</div> : (
                              <table className="w-full text-left">
                                <thead className="bg-stone-50 border-b text-stone-500 text-sm uppercase"><tr><th className="p-4">อีเมล</th><th className="p-4">สิทธิ์</th><th className="p-4 text-right">จัดการ</th></tr></thead>
                                <tbody className="divide-y divide-stone-100">
                                  {users.map(u => (
                                    <tr key={u.id}>
                                      <td className="p-4">{u.email}</td>
                                      <td className="p-4"><span className="bg-blue-100 text-blue-700 px-2 py-1 rounded text-xs uppercase">{u.role}</span></td>
                                      <td className="p-4 text-right">{u.email !== HOST_EMAIL && <button onClick={() => handleRemoveUser(u.id)} className="text-red-500 hover:underline">ลบ</button>}</td>
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            )}
                         </div>
                     </div>
                  )}
                </div>
              </div>
            </div>
          );
        }

        // --- Helper Components ---
        function NavButton({ active, onClick, children }) {
          return (
            <button
              onClick={onClick}
              className={`px-3 py-2 rounded-md text-sm font-medium transition ${
                active
                  ? 'bg-[#116900]/10 text-[#116900] font-bold'
                  : 'text-stone-500 hover:text-[#116900] hover:bg-stone-50'
              }`}
            >
              {children}
            </button>
          );
        }

        function MobileNavBtn({ onClick, children }) {
          return (
            <button
              onClick={onClick}
              className="block w-full text-left px-3 py-2 rounded-md text-base font-medium text-stone-600 hover:bg-stone-50 hover:text-[#116900]"
            >
              {children}
            </button>
          );
        }

        function LoginModal({ onClose, onLoginWithGoogle }) {
          return (
            <div className="fixed inset-0 z-[70] bg-black/50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
              <div className="bg-white rounded-2xl shadow-xl max-w-sm w-full overflow-hidden">
                <div className="p-8 text-center">
                  <div className="flex justify-end mb-2">
                    <button onClick={onClose} className="text-stone-400 hover:text-stone-600"><X size={24}/></button>
                  </div>
                  
                  <div className="w-16 h-16 bg-stone-100 rounded-full flex items-center justify-center mx-auto mb-4">
                     <ShieldCheck size={32} className="text-[#116900]" />
                  </div>
                  
                  <h3 className="text-xl font-bold text-stone-800 mb-2">เข้าสู่ระบบหลังบ้าน</h3>
                  <p className="text-sm text-stone-500 mb-8">เฉพาะผู้ที่ได้รับอนุญาตเท่านั้น</p>
                  
                  <button
                    onClick={onLoginWithGoogle}
                    className="w-full flex items-center justify-center gap-3 bg-white border border-stone-300 py-3 px-4 rounded-xl font-bold text-stone-700 hover:bg-stone-50 transition shadow-sm"
                  >
                    <img className="w-5 h-5" alt="google" 
                      style={{filter: 'none'}}
                      src="https://fonts.gstatic.com/s/i/productlogos/googleg/v6/24px.svg" 
                    />
                    เข้าสู่ระบบด้วย Google
                  </button>
                </div>
              </div>
            </div>
          );
        }

        // --- Mount App ---
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);

    </script>
</body>
</html>
